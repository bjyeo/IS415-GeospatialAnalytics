{
  "hash": "93adc4594d50707a866d981de81ab97c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Take Home Exercise 3\"\nauthor: \"Bao Jie Yeo\"\ndate: '2024-11-03'\ndate-modified: '2024-11-03'\nexecute: \n  eval: true\n  echo: true\n  freeze: true\n---\n\n\n## 1.0 Geospatial Analysis of Jakarta Schools\n\n### 1.1 Overview\n\n### 1.2 Significance and Impact\n\n### 1.3 Research Focus\n\n### 1.4 Datasets\n\n## 2.0 Data Preprocessing\n\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(sf, tidyverse, knitr, viridis, patchwork, gridExtra, kableExtra, sfdep, tmap, tmaptools, patchwork, scales, spdep, ggrepel, spatstat)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nindo_schools_kaggle <- read_csv(\"data/aspatial/complete_data.csv\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nRows: 215371 Columns: 11\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr (6): province_name, city_name, district_name, school_name, stage, status\ndbl (5): lat, long, province_area, total_population, total_education_age_pop...\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\njakarta_schools <- indo_schools_kaggle %>% \n  filter(province_name == \"DKI JAKARTA\",\n         city_name != \"Kab. Kepulauan Seribu\") %>%\n  filter(!is.na(long) & !is.na(lat)) %>%\n  st_as_sf(coords = c(\"long\", \"lat\"), crs = 4326) %>%\n  mutate(\n      school_level = case_when(\n        stage %in% c(\"SD\", \"SDLB\") ~ \"Elementary\",\n        stage %in% c(\"SMP\", \"SMPLB\") ~ \"Junior High\",\n        stage %in% c(\"SMA\", \"SMK\", \"SMLB\") ~ \"Senior High\",\n        TRUE ~ \"Special Education\"\n      ),\n      school_type = if_else(status == \"N\", \"Public\", \"Private\")\n    )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(jakarta_schools)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 6 features and 11 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: 106.8139 ymin: -6.1992 xmax: 106.8642 ymax: -6.1462\nGeodetic CRS:  WGS 84\n# A tibble: 6 × 12\n  province_name city_name   district_name school_name stage status province_area\n  <chr>         <chr>       <chr>         <chr>       <chr> <chr>          <dbl>\n1 DKI JAKARTA   Kota Jakar… Kec. Tanah A… SD NEGERI … SD    N                664\n2 DKI JAKARTA   Kota Jakar… Kec. Senen    SDN Kenari… SD    N                664\n3 DKI JAKARTA   Kota Jakar… Kec. Johar B… SD NEGERI … SD    N                664\n4 DKI JAKARTA   Kota Jakar… Kec. Menteng  SMAS PSKD … SMA   S                664\n5 DKI JAKARTA   Kota Jakar… Kec. Sawah B… SMKS STRAD… SMK   S                664\n6 DKI JAKARTA   Kota Jakar… Kec. Cempaka… SDN Cempak… SD    N                664\n# ℹ 5 more variables: total_population <dbl>,\n#   total_education_age_population <dbl>, geometry <POINT [°]>,\n#   school_level <chr>, school_type <chr>\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nadm2 <- st_read(\"data/geospatial\", layer = \"geoBoundaries-IDN-ADM2_simplified\") %>%\n  filter(shapeName %in% c(\n      \"Kota Jakarta Barat\", \"Kota Jakarta Pusat\",\n      \"Kota Jakarta Selatan\", \"Kota Jakarta Timur\",\n      \"Kota Jakarta Utara\"\n    ))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `geoBoundaries-IDN-ADM2_simplified' from data source \n  `C:\\Users\\yeoba\\Desktop\\bjyeo\\IS415-GeospatialAnalytics\\TakehomeEx\\THE03\\data\\geospatial' \n  using driver `ESRI Shapefile'\nSimple feature collection with 519 features and 5 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 95.01115 ymin: -11.00762 xmax: 141.0194 ymax: 6.07693\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbatas <- st_read(\"data/geospatial\", layer = \"BATAS_DESA_DESEMBER_2019_DUKCAPIL_DKI_JAKARTA\")  %>%\n    select(OBJECT_ID, PROVINSI, KAB_KOTA, KECAMATAN, DESA_KELUR, \n         JUMLAH_PEN, JUMLAH_KK, LUAS_WILAY, KEPADATAN, geometry) %>%\n    rename(\n    province = PROVINSI,\n    city = KAB_KOTA,\n    district = KECAMATAN,\n    subdistrict = DESA_KELUR,\n    population = JUMLAH_PEN,\n    total_families = JUMLAH_KK,\n    area_size = LUAS_WILAY,\n    popn_density = KEPADATAN\n    ) %>%\n    filter(!is.na(city) & city != \"KEPULAUAN SERIBU\") %>%\n    mutate(city = case_when(\n      city == \"JAKARTA BARAT\" ~ \"Kota Jakarta Barat\",\n      city == \"JAKARTA PUSAT\" ~ \"Kota Jakarta Pusat\",\n      city == \"JAKARTA SELATAN\" ~ \"Kota Jakarta Selatan\",\n      city == \"JAKARTA TIMUR\" ~ \"Kota Jakarta Timur\",\n      city == \"JAKARTA UTARA\" ~ \"Kota Jakarta Utara\",\n      TRUE ~ city\n    ))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `BATAS_DESA_DESEMBER_2019_DUKCAPIL_DKI_JAKARTA' from data source \n  `C:\\Users\\yeoba\\Desktop\\bjyeo\\IS415-GeospatialAnalytics\\TakehomeEx\\THE03\\data\\geospatial' \n  using driver `ESRI Shapefile'\nSimple feature collection with 269 features and 161 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 106.3831 ymin: -6.370815 xmax: 106.9728 ymax: -5.184322\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(batas)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 6 features and 9 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 106.8105 ymin: -6.17575 xmax: 106.8711 ymax: -6.141043\nGeodetic CRS:  WGS 84\n  OBJECT_ID    province               city    district   subdistrict population\n1     25477 DKI JAKARTA Kota Jakarta Barat  TAMAN SARI     KEAGUNGAN      21609\n2     25478 DKI JAKARTA Kota Jakarta Barat  TAMAN SARI        GLODOK       9069\n3     25397 DKI JAKARTA Kota Jakarta Pusat   KEMAYORAN HARAPAN MULIA      29085\n4     25400 DKI JAKARTA Kota Jakarta Pusat   KEMAYORAN  CEMPAKA BARU      41913\n5     25390 DKI JAKARTA Kota Jakarta Pusat SAWAH BESAR    PASAR BARU      15793\n6     25391 DKI JAKARTA Kota Jakarta Pusat SAWAH BESAR  KARANG ANYAR      33383\n  total_families area_size popn_density                       geometry\n1           7255      0.36        60504 MULTIPOLYGON (((106.8164 -6...\n2           3273      0.37        24527 MULTIPOLYGON (((106.8148 -6...\n3           9217      0.53        54465 MULTIPOLYGON (((106.8576 -6...\n4          13766      0.97        42993 MULTIPOLYGON (((106.8631 -6...\n5           5599      1.76         8971 MULTIPOLYGON (((106.8369 -6...\n6          11276      0.47        71628 MULTIPOLYGON (((106.8316 -6...\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndistrict_mapping <- c(\n    \"TAMAN SARI\" = \"Kec. Taman Sari\",\n    \"KEMAYORAN\" = \"Kec. Kemayoran\",\n    \"SAWAH BESAR\" = \"Kec. Sawah Besar\",\n    \"GAMBIR\" = \"Kec. Gambir\",\n    \"SENEN\" = \"Kec. Senen\",\n    \"CEMPAKA PUTIH\" = \"Kec. Cempaka Putih\",\n    \"MENTENG\" = \"Kec. Menteng\",\n    \"TANAH ABANG\" = \"Kec. Tanah Abang\",\n    \"JOHAR BARU\" = \"Kec. Johar Baru\",\n    \"KOJA\" = \"Kec. Koja\",\n    \"PENJARINGAN\" = \"Kec. Penjaringan\",\n    \"TANJUNG PRIOK\" = \"Kec. Tanjung Priok\",\n    \"CILINCING\" = \"Kec. Cilincing\",\n    \"GROGOL PETAMBURAN\" = \"Kec. Grogol Petamburan\",\n    \"PADEMANGAN\" = \"Kec. Pademangan\",\n    \"KELAPA GADING\" = \"Kec. Kelapa Gading\",\n    \"CENGKARENG\" = \"Kec. Cengkareng\",\n    \"TAMBORA\" = \"Kec. Tambora\",\n    \"KEBON JERUK\" = \"Kec. Kebon Jeruk\",\n    \"KALIDERES\" = \"Kec. Kali Deres\",\n    \"PAL MERAH\" = \"Kec. Palmerah\",\n    \"JATINEGARA\" = \"Kec. Jatinegara\",\n    \"KEMBANGAN\" = \"Kec. Kembangan\",\n    \"TEBET\" = \"Kec. Tebet\",\n    \"SETIABUDI\" = \"Kec. Setia Budi\",\n    \"MAMPANG PRAPATAN\" = \"Kec. Mampang Prapatan\",\n    \"PASAR MINGGU\" = \"Kec. Pasar Minggu\",\n    \"KEBAYORAN LAMA\" = \"Kec. Kebayoran Lama\",\n    \"KEBAYORAN BARU\" = \"Kec. Kebayoran Baru\",\n    \"CILANDAK\" = \"Kec. Cilandak\",\n    \"PESANGGRAHAN\" = \"Kec. Pesanggrahan\",\n    \"PANCORAN\" = \"Kec. Pancoran\",\n    \"JAGAKARSA\" = \"Kec. Jagakarsa\",\n    \"MATRAMAN\" = \"Kec. Matraman\",\n    \"PULOGADUNG\" = \"Kec. Pulo Gadung\",\n    \"KRAMATJATI\" = \"Kec. Kramat Jati\",\n    \"PASAR REBO\" = \"Kec. Pasar Rebo\",\n    \"DUREN SAWIT\" = \"Kec. Duren Sawit\",\n    \"MAKASAR\" = \"Kec. Makasar\",\n    \"CIRACAS\" = \"Kec. Ciracas\",\n    \"CIPAYUNG\" = \"Kec. Cipayung\",\n    \"CAKUNG\" = \"Kec. Cakung\"\n)\n\nbatas <- batas %>%\n  mutate(district = district_mapping[district])\n```\n:::\n\n\n## 3.0 Exploratory Data Analysis (Provincial Level)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = jakarta_schools) +\n  geom_bar(aes(x = city_name, fill = city_name)) +\n  scale_fill_viridis_d(option = \"plasma\") +\n  theme_minimal() +\n  theme(\n    axis.text.x = element_text(angle = 45, hjust = 1),\n    plot.title = element_text(size = 12, face = \"bold\"),\n    legend.position = \"none\"\n  ) +\n  labs(\n    title = \"Distribution of Schools Across Jakarta\",\n    x = \"City\",\n    y = \"Number of Schools\"\n  )\n```\n\n::: {.cell-output-display}\n![](THE03_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n**Key Observations**:\n\n-   The plot reveals significant disparity in school distribution across Jakarta\n-   East Jakarta (Timur) has the highest number of schools, followed by West Jakarta (Barat) then South Jakarta (Selatan). This is consistent with the population density distribution in Jakarta.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = jakarta_schools) +\n  geom_bar(aes(x = city_name, fill = school_level)) +\n  scale_fill_viridis_d(option = \"plasma\") +\n  theme_minimal() +\n  theme(\n    axis.text.x = element_text(angle = 45, hjust = 1),\n    plot.title = element_text(size = 12, face = \"bold\")\n  ) +\n  labs(\n    title = \"Distribution of School Levels Across Jakarta\",\n    x = \"City\",\n    y = \"Number of Schools\",\n    fill = \"School Level\"\n  )\n```\n\n::: {.cell-output-display}\n![](THE03_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n**Key Observations**:\n\n-   Across all municipalities, elementary schools are the most common\n-   There is a relatively consistent proportion of Junior and Senior High Schools\n-   Special Education schools are less common but present in all municipalities\n-   While total numbers differ, the proportional distribution of school levels remains fairly consistent across cities, suggesting **planned distribution** rather than random clustering\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = adm2, aes(fill = lengths(st_intersects(adm2, jakarta_schools)))) +\n  scale_fill_viridis_c(option = \"plasma\") +\n  theme_minimal() +\n  labs(\n    title = \"School Density Across Jakarta\",\n    fill = \"Number of\\nSchools\"\n  )\n```\n\n::: {.cell-output-display}\n![](THE03_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = batas, aes(fill = popn_density)) +\n  scale_fill_viridis_c(\n    option = \"plasma\",\n    labels = scales::comma_format()\n  ) +\n  theme_minimal() +\n  labs(\n    title = \"Population Density in Jakarta\",\n    fill = \"Population\\nDensity\\n(per km²)\"\n  )\n```\n\n::: {.cell-output-display}\n![](THE03_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\n**Key Observations**:\n\n-   The density map reveals high population clusters in central Jakarta (yellow/orange areas)\n-   There is an interesting mismatch with school density in some areas\n-   Several high-density pockets are scattered across Jakarta\n\n### Summary\n\n-   Our preliminary EDA at the provincial level is too macro to provide detailed insights, but necessary to understand the overall distribution of schools in Jakarta\n-   Certain patterns of school and population concentration emerge, but we will need to confirm this with KDE and statistical tests\n-   We still cannot determine if the school distribution matches population needs\n\n## 4.0 Kernel Density Estimation (Provincial Level)\n\n### 4.1 Provincial KDE\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Convert to UTM projection for proper distance calculations\njakarta_schools_utm <- st_transform(jakarta_schools, 32748)\nadm2_utm <- st_transform(adm2, 32748)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncoords <- st_coordinates(jakarta_schools_utm)\njittered_coords <- coords + matrix(\n  runif(nrow(coords) * 2, -0.1, 0.1),\n  ncol = 2\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nwindow <- as.owin(st_union(adm2_utm))\n\ninside <- inside.owin(x = jittered_coords[,1], \n                     y = jittered_coords[,2], \n                     w = window)\nvalid_coords <- jittered_coords[inside,]\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npoints <- ppp(\n  x = valid_coords[,1],\n  y = valid_coords[,2],\n  window = window\n)\n\nprint(paste(\"Original points:\", nrow(coords)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"Original points: 4762\"\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(paste(\"Points in window:\", sum(inside)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"Points in window: 4734\"\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(paste(\"Duplicated points:\", sum(duplicated(valid_coords))))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"Duplicated points: 0\"\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nkde <- density.ppp(points, \n                  sigma = bw.diggle(points),\n                  edge = TRUE)\nkde_df <- as.data.frame(kde)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = adm2_utm, fill = \"transparent\") +\n  geom_tile(data = kde_df, aes(x = x, y = y, fill = value)) +\n  scale_fill_viridis_c(option = \"plasma\") +\n  theme_minimal() +\n  labs(\n    title = \"Kernel Density Estimation of All Schools\",\n    subtitle = paste0(\"Based on \", sum(inside), \" school locations\"),\n    fill = \"Density\"\n  )\n```\n\n::: {.cell-output-display}\n![](THE03_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\n**Key Observations**:\n\n-   The overall KDE map shows spatial clustering with several high-density hotspots\n-   The strongest concentration is in North-Central Jakarta (around 6.15S)\n-   Secondary clusters appear in the eastern and western regions\n-   Southern areas generally show lower density\n-   This patterns strongly suggests rejecting the null hypothesis of random distribution\n\n### 4.2 KDE by School Level\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Individual KDE by school level\nkde_plots <- list()\n\n# Process each school level\nfor(level in unique(jakarta_schools_utm$school_level)) {\n  schools_subset <- jakarta_schools_utm[jakarta_schools_utm$school_level == level,]\n  \n  coords <- st_coordinates(schools_subset)\n  jittered_coords <- coords + matrix(\n    runif(nrow(coords) * 2, -0.1, 0.1),\n    ncol = 2\n  )\n  \n  inside <- inside.owin(x = jittered_coords[,1],\n                       y = jittered_coords[,2],\n                       w = window)\n  valid_coords <- jittered_coords[inside,]\n  \n  points_subset <- ppp(\n    x = valid_coords[,1],\n    y = valid_coords[,2],\n    window = window\n  )\n  \n  kde_level <- density.ppp(points_subset,\n                          sigma = bw.diggle(points_subset),\n                          edge = TRUE)\n  kde_df <- as.data.frame(kde_level)\n  \n  kde_plots[[level]] <- ggplot() +\n    geom_sf(data = adm2_utm, fill = \"transparent\") +\n    geom_tile(data = kde_df, aes(x = x, y = y, fill = value)) +\n    scale_fill_viridis_c(option = \"plasma\") +\n    theme_minimal() +\n    labs(\n      title = paste(\"School Density:\", level),\n      subtitle = paste0(\"Based on \", sum(inside), \" school locations\"),\n      fill = \"Density\"\n    )\n}\n\nwalk(kde_plots, print)\n```\n\n::: {.cell-output-display}\n![](THE03_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](THE03_files/figure-html/unnamed-chunk-19-2.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](THE03_files/figure-html/unnamed-chunk-19-3.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](THE03_files/figure-html/unnamed-chunk-19-4.png){width=672}\n:::\n:::\n\n\n**Key Observations**:\n\n-   The KDE plots reveal distinct non-random spatial patterns in school distribution\n-   The most intense clustering appears in the North-Central region across all school types\n-   Density patterns vary by school level. Elementary schools show more dispersed, localized hotspots. Secondary schools display stronger clustering and special education schools show unique clustering patterns in central and southwestern regions.\n\n### 4.3 Quadrat Analysis\n\n**Spatial Distribution**\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoords <- st_coordinates(jakarta_schools_utm)\njittered_coords <- coords + matrix(\n  runif(nrow(coords) * 2, -0.1, 0.1),\n  ncol = 2\n)\n\ninside <- inside.owin(x = jittered_coords[,1],\n                     y = jittered_coords[,2],\n                     w = window)\n\nvalid_coords <- jittered_coords[inside,]\nvalid_marks <- jakarta_schools_utm$school_level[inside]\n\nprint(paste(\"Number of valid coordinates:\", nrow(valid_coords)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"Number of valid coordinates: 4734\"\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(paste(\"Number of valid marks:\", length(valid_marks)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"Number of valid marks: 4734\"\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nquadrat_points <- ppp(\n  x = valid_coords[,1],\n  y = valid_coords[,2],\n  window = window,\n  marks = factor(valid_marks)\n)\n\nq <- quadratcount(quadrat_points, nx = 6, ny = 6)\n\nggplot() +\n  geom_sf(data = adm2_utm, fill = \"transparent\") +\n  stat_density2d(\n    data = as.data.frame(valid_coords),\n    aes(x = X, y = Y, fill = after_stat(level)),\n    geom = \"polygon\",\n    alpha = 0.5,\n    contour = TRUE\n  ) +\n  geom_point(\n    data = data.frame(\n      X = valid_coords[,1],\n      Y = valid_coords[,2],\n      Level = valid_marks\n    ),\n    aes(x = X, y = Y, color = Level),\n    alpha = 0.6,\n    size = 2\n  ) +\n  scale_fill_viridis_c(option = \"plasma\", name = \"Density\") +\n  scale_color_viridis_d(option = \"plasma\", name = \"School Level\") +\n  theme_minimal() +\n  labs(\n    title = \"Quadrat Analysis of Schools in Jakarta\",\n    subtitle = paste(\"Based on\", nrow(valid_coords), \" school locations\")\n  )\n```\n\n::: {.cell-output-display}\n![](THE03_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n:::\n\n\n**Key Observations**:\n\n-   The quadrat analysis confirms the non-random distribution of schools in Jakarta\n-   Elementary schools show widest spatial coverage, secondary schools tend to be clustered together and special education facilities are sparsely distributed\n-   Higher density areas correspond to areas with multiple school types\n\n**Statistical Analysis**\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Chi-square test\nq_test <- quadrat.test(quadrat_points)\nprint(\"Quadrat Test Results:\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"Quadrat Test Results:\"\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(q_test)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\tChi-squared test of CSR using quadrat counts\n\ndata:  quadrat_points\nX2 = 513.45, df = 22, p-value < 2.2e-16\nalternative hypothesis: two.sided\n\nQuadrats: 23 tiles (irregular windows)\n```\n\n\n:::\n:::\n\n\nFrom the Chi-squared test, the **extremely low p-value** \\< 2.2e-16 strongly **rejects the null hypothesis** of Complete Spatial Randomness (CSR). The high chi-squared value of 513.45 indicates substantial deviation from expected frequencies. The results statistically confirm the visual clustering patterns.\n\n**Frequency Analysis**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nquadrat_summary <- data.frame(\n  observed = as.vector(q),\n  expected = mean(as.vector(q)),\n  quadrat = 1:length(as.vector(q))\n)\n\nggplot(quadrat_summary) +\n  geom_point(aes(x = quadrat, y = observed), color = \"blue\", alpha = 0.6) +\n  geom_hline(yintercept = mean(quadrat_summary$expected), \n             linetype = \"dashed\", color = \"red\") +\n  theme_minimal() +\n  labs(\n    title = \"Observed vs Expected Quadrat Frequencies\",\n    x = \"Quadrat Number\",\n    y = \"Frequency\",\n    caption = \"Red line indicates expected frequency under CSR\"\n  )\n```\n\n::: {.cell-output-display}\n![](THE03_files/figure-html/unnamed-chunk-23-1.png){width=672}\n:::\n:::\n\n\n**Key Observations**:\n\n-   There is **large variation** in observed frequencies across quadrats\n-   Most quadrats show frequencies significantly different from expected (red line)\n-   Several quadrats show very high frequencies (\\>300 schools). Some quadrats show very low frequencies (\\<100 schools)\n-   This pattern suggests **strong deviation from CSR**\n\n## 5.0 Exploratory Data Analysis (City Level)\n\n### 5.1 School Distribution by City\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create individual maps for each city\nbatas_utm <- st_transform(batas, 32748)\ncity_maps <- list()\n\nfor(city in unique(batas$city)) {\n  city_boundary <- batas_utm[batas_utm$city == city,]\n  \n  city_schools <- jakarta_schools_utm[st_intersects(jakarta_schools_utm, \n                                                   st_union(city_boundary)) %>% \n                                      lengths > 0,]\n  \n  city_maps[[city]] <- ggplot() +\n    geom_sf(data = city_boundary, \n            aes(fill = popn_density)) +\n    geom_sf(data = city_schools,\n            aes(color = school_level),\n            size = 2,\n            alpha = 0.6) +\n    scale_fill_viridis_c(\n      option = \"plasma\",\n      name = \"Population\\nDensity\",\n      labels = scales::comma_format()\n    ) +\n    scale_color_viridis_d(\n      option = \"plasma\",\n      name = \"School Level\"\n    ) +\n    theme_minimal() +\n    theme(\n      plot.title = element_text(size = 14, face = \"bold\"),\n      plot.subtitle = element_text(size = 12),\n      legend.title = element_text(size = 10),\n      legend.text = element_text(size = 8),\n      plot.margin = margin(10, 10, 10, 10)\n    ) +\n    labs(\n      title = paste(\"Schools Distribution in\", city),\n      subtitle = paste(\"Number of schools:\", nrow(city_schools))\n    )\n}\n\n# Display all maps\nwalk(names(city_maps), function(city) {\n  print(city_maps[[city]])\n})\n```\n\n::: {.cell-output-display}\n![](THE03_files/figure-html/unnamed-chunk-24-1.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](THE03_files/figure-html/unnamed-chunk-24-2.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](THE03_files/figure-html/unnamed-chunk-24-3.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](THE03_files/figure-html/unnamed-chunk-24-4.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](THE03_files/figure-html/unnamed-chunk-24-5.png){width=672}\n:::\n:::\n\n\n### 5.2 Public School Ratio by City\n\n\n::: {.cell}\n\n```{.r .cell-code}\npublic_ratio <- jakarta_schools_utm %>%\n  group_by(city_name) %>%\n  summarise(\n    total_schools = n(),\n    public_schools = sum(school_type == \"Public\"),\n    public_ratio = public_schools / total_schools,\n    .groups = \"drop\"\n  )\n\nggplot(public_ratio) +\n  geom_bar(aes(x = reorder(city_name, public_ratio), \n               y = public_ratio, \n               fill = city_name), \n           stat = \"identity\") +\n  scale_fill_viridis_d(option = \"plasma\") +\n  theme_minimal() +\n  theme(\n    axis.text.x = element_text(angle = 45, hjust = 1),\n    legend.position = \"none\",\n    plot.title = element_text(size = 14, face = \"bold\"),\n    plot.subtitle = element_text(size = 12)\n  ) +\n  labs(\n    title = \"Public School Ratio by City\",\n    subtitle = \"Proportion of public schools to total schools\",\n    x = \"City\",\n    y = \"Proportion of Public Schools\"\n  )\n```\n\n::: {.cell-output-display}\n![](THE03_files/figure-html/unnamed-chunk-25-1.png){width=672}\n:::\n:::\n\n\n**Key Observations**:\n\n-   The public school ratio varies significantly across cities\n-   The highest ratios is in Jakarta Selatan, which is surprisingly since South Jakarta has the third highest population in Jakarta\n-   This suggests an uneven distribution of public education resources\n\n### 5.3 Nearest Neighbour Analysis\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnn_analysis <- list()\nfor(city in unique(jakarta_schools_utm$city_name)) {\n  # Get schools for this city\n  city_schools <- jakarta_schools_utm[jakarta_schools_utm$city_name == city,]\n  city_boundary <- adm2_utm[adm2_utm$shapeName == city,]\n  \n  # Get coordinates and add jitter\n  coords <- st_coordinates(city_schools)\n  jittered_coords <- coords + matrix(\n    runif(nrow(coords) * 2, -0.1, 0.1),\n    ncol = 2\n  )\n  \n  # Create window for this city\n  city_window <- as.owin(st_union(city_boundary))\n  \n  # Filter valid points\n  inside <- inside.owin(x = jittered_coords[,1],\n                       y = jittered_coords[,2],\n                       w = city_window)\n  valid_coords <- jittered_coords[inside,]\n  \n  # Calculate NN statistics\n  points_ppp <- ppp(\n    x = valid_coords[,1],\n    y = valid_coords[,2],\n    window = city_window\n  )\n  \n  # Store results\n  nn_analysis[[city]] <- data.frame(\n    city = city,\n    observed_mean_dist = mean(nndist(points_ppp)),\n    n_points = npoints(points_ppp),\n    area = area.owin(city_window),\n    expected_mean_dist = 1/(2*sqrt(npoints(points_ppp)/area.owin(city_window))),\n    stringsAsFactors = FALSE\n  )\n}\n\nnn_df <- bind_rows(nn_analysis) %>%\n  mutate(R = observed_mean_dist/expected_mean_dist)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nnn_df %>%\n  select(city, observed_mean_dist, n_points, expected_mean_dist, R) %>%\n  arrange(R) %>%\n  kable(\"html\") %>%\n  kable_styling(\"striped\", full_width = FALSE)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> city </th>\n   <th style=\"text-align:right;\"> observed_mean_dist </th>\n   <th style=\"text-align:right;\"> n_points </th>\n   <th style=\"text-align:right;\"> expected_mean_dist </th>\n   <th style=\"text-align:right;\"> R </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Kota Jakarta Pusat </td>\n   <td style=\"text-align:right;\"> 69.2495 </td>\n   <td style=\"text-align:right;\"> 563 </td>\n   <td style=\"text-align:right;\"> 145.7152 </td>\n   <td style=\"text-align:right;\"> 0.4752388 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Kota Jakarta Utara </td>\n   <td style=\"text-align:right;\"> 112.5728 </td>\n   <td style=\"text-align:right;\"> 718 </td>\n   <td style=\"text-align:right;\"> 221.0842 </td>\n   <td style=\"text-align:right;\"> 0.5091852 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Kota Jakarta Selatan </td>\n   <td style=\"text-align:right;\"> 110.4327 </td>\n   <td style=\"text-align:right;\"> 1018 </td>\n   <td style=\"text-align:right;\"> 188.6140 </td>\n   <td style=\"text-align:right;\"> 0.5854960 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Kota Jakarta Timur </td>\n   <td style=\"text-align:right;\"> 112.8154 </td>\n   <td style=\"text-align:right;\"> 1312 </td>\n   <td style=\"text-align:right;\"> 187.4971 </td>\n   <td style=\"text-align:right;\"> 0.6016915 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Kota Jakarta Barat </td>\n   <td style=\"text-align:right;\"> 112.5448 </td>\n   <td style=\"text-align:right;\"> 1098 </td>\n   <td style=\"text-align:right;\"> 169.0853 </td>\n   <td style=\"text-align:right;\"> 0.6656096 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(nn_df) +\n  geom_bar(aes(x = reorder(city, R), y = R, fill = city),\n           stat = \"identity\") +\n  geom_hline(yintercept = 1, linetype = \"dashed\", color = \"red\") +\n  scale_fill_viridis_d(option = \"plasma\") +\n  theme_minimal() +\n  theme(\n    axis.text.x = element_text(angle = 45, hjust = 1),\n    legend.position = \"none\"\n  ) +\n  labs(\n    title = \"Nearest Neighbor Analysis by City\",\n    subtitle = \"R < 1 indicates clustering, R > 1 indicates dispersion\",\n    x = \"City\",\n    y = \"R Statistic\"\n  )\n```\n\n::: {.cell-output-display}\n![](THE03_files/figure-html/unnamed-chunk-28-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(nn_df) +\n  geom_segment(aes(x = city, xend = city,\n                   y = expected_mean_dist, yend = observed_mean_dist),\n               color = \"gray50\") +\n  geom_point(aes(x = city, y = expected_mean_dist), color = \"blue\", size = 3) +\n  geom_point(aes(x = city, y = observed_mean_dist), color = \"red\", size = 3) +\n  theme_minimal() +\n  theme(\n    axis.text.x = element_text(angle = 45, hjust = 1)\n  ) +\n  labs(\n    title = \"Expected vs Observed Mean Nearest Neighbor Distances\",\n    subtitle = \"Blue: Expected, Red: Observed\",\n    x = \"City\",\n    y = \"Distance (meters)\"\n  )\n```\n\n::: {.cell-output-display}\n![](THE03_files/figure-html/unnamed-chunk-29-1.png){width=672}\n:::\n:::\n\n\n**Key Observations**:\n\n-   All cities show an R-value \\< 1 confirming significant clustering\n-   The strongest clustering is in Jakarta Pusat (0.48) and most dispersed in Jakarta Barat (0.67)\n-   All cities show observed distances significantly lower than expected, confirming non-random distribution\n\n### 5.4 Cross K Function Analysis\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncross_k_analysis <- list()\n\nfor(city in unique(jakarta_schools_utm$city_name)) {\n  # Get schools for this city\n  city_schools <- jakarta_schools_utm[jakarta_schools_utm$city_name == city,]\n  city_boundary <- adm2_utm[adm2_utm$shapeName == city,]\n  city_window <- as.owin(st_union(city_boundary))\n  \n  # Separate public and private schools\n  public_schools <- city_schools[city_schools$school_type == \"Public\",]\n  private_schools <- city_schools[city_schools$school_type == \"Private\",]\n  \n  # Add jitter to coordinates\n  public_coords <- st_coordinates(public_schools)\n  private_coords <- st_coordinates(private_schools)\n  \n  public_jitter <- public_coords + matrix(\n    runif(nrow(public_coords) * 2, -0.1, 0.1),\n    ncol = 2\n  )\n  private_jitter <- private_coords + matrix(\n    runif(nrow(private_coords) * 2, -0.1, 0.1),\n    ncol = 2\n  )\n  \n  # Filter points within window\n  public_inside <- inside.owin(x = public_jitter[,1],\n                              y = public_jitter[,2],\n                              w = city_window)\n  private_inside <- inside.owin(x = private_jitter[,1],\n                               y = private_jitter[,2],\n                               w = city_window)\n  \n  public_valid <- public_jitter[public_inside,]\n  private_valid <- private_jitter[private_inside,]\n  \n  # Create marked point pattern\n  points_ppp <- ppp(\n    x = c(public_valid[,1], private_valid[,1]),\n    y = c(public_valid[,2], private_valid[,2]),\n    window = city_window,\n    marks = factor(c(\n      rep(\"Public\", nrow(public_valid)),\n      rep(\"Private\", nrow(private_valid))\n    ))\n  )\n  \n  # Calculate cross K function\n  cross_k <- Kcross(points_ppp, \n                    i = \"Public\", \n                    j = \"Private\",\n                    correction = \"border\")\n  \n  cross_k_analysis[[city]] <- data.frame(\n    r = cross_k$r,\n    theo = cross_k$theo,\n    obs = cross_k$border,\n    city = city\n  )\n}\n\n# Combine results\ncross_k_df <- bind_rows(cross_k_analysis)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(cross_k_df) +\n  geom_line(aes(x = r, y = theo), color = \"red\", linetype = \"dashed\") +\n  geom_line(aes(x = r, y = obs, color = city)) +\n  facet_wrap(~city) +\n  scale_color_viridis_d(option = \"plasma\") +\n  theme_minimal() +\n  labs(\n    title = \"Cross K Function: Public vs Private Schools\",\n    subtitle = \"Red dashed line: theoretical CSR\",\n    x = \"Distance (r)\",\n    y = \"K(r)\"\n  )\n```\n\n::: {.cell-output-display}\n![](THE03_files/figure-html/unnamed-chunk-31-1.png){width=672}\n:::\n:::\n\n\n**Key Observations**:\n\n-   All cities show observed values above the CSR line. Public and private schools tend to cluster together, and there is stronger clustering at shorter distances.\n-   Notably:\n    -   Jakarta Timur shows strongest deviation from CSR\n    -   Jakarta Selatan is most consistent with CSR\n    -   Jakarta Pusat shows moderate clustering at all distances\n    \n\n### 5.5 K Function and L Function Analysis\n\n\n::: {.cell}\n\n```{.r .cell-code}\nk_l_analysis <- list()\n\nfor(city in unique(jakarta_schools_utm$city_name)) {\n  city_schools <- jakarta_schools_utm[jakarta_schools_utm$city_name == city,]\n  city_boundary <- adm2_utm[adm2_utm$shapeName == city,]\n  \n  # Create window and points\n  city_window <- as.owin(st_union(city_boundary))\n  coords <- st_coordinates(city_schools)\n  jittered_coords <- coords + matrix(\n    runif(nrow(coords) * 2, -0.1, 0.1),\n    ncol = 2\n  )\n  \n  inside <- inside.owin(x = jittered_coords[,1],\n                       y = jittered_coords[,2],\n                       w = city_window)\n  valid_coords <- jittered_coords[inside,]\n  \n  points_ppp <- ppp(\n    x = valid_coords[,1],\n    y = valid_coords[,2],\n    window = city_window\n  )\n  \n  # Calculate K and L functions\n  k_func <- Kest(points_ppp, correction = \"border\")\n  l_func <- Lest(points_ppp, correction = \"border\")\n  \n  k_l_analysis[[city]] <- list(\n    k = k_func,\n    l = l_func\n  )\n}\n\n# Plot K function\nk_plot_data <- lapply(names(k_l_analysis), function(city) {\n  data.frame(\n    r = k_l_analysis[[city]]$k$r,\n    theo = k_l_analysis[[city]]$k$theo,\n    obs = k_l_analysis[[city]]$k$border,\n    city = city\n  )\n}) %>% bind_rows()\n\np_k <- ggplot(k_plot_data) +\n  geom_line(aes(x = r, y = theo), color = \"red\", linetype = \"dashed\") +\n  geom_line(aes(x = r, y = obs, color = city)) +\n  facet_wrap(~city) +\n  scale_color_viridis_d(option = \"plasma\") +\n  theme_minimal() +\n  labs(\n    title = \"Ripley's K Function by City\",\n    subtitle = \"Red dashed line: theoretical CSR\",\n    x = \"Distance (r)\",\n    y = \"K(r)\"\n  )\n\n# Plot L function\nl_plot_data <- lapply(names(k_l_analysis), function(city) {\n  data.frame(\n    r = k_l_analysis[[city]]$l$r,\n    theo = k_l_analysis[[city]]$l$theo,\n    obs = k_l_analysis[[city]]$l$border - k_l_analysis[[city]]$l$r,\n    city = city\n  )\n}) %>% bind_rows()\n\np_l <- ggplot(l_plot_data) +\n  geom_hline(yintercept = 0, linetype = \"dashed\", color = \"red\") +\n  geom_line(aes(x = r, y = obs, color = city)) +\n  facet_wrap(~city) +\n  scale_color_viridis_d(option = \"plasma\") +\n  theme_minimal() +\n  labs(\n    title = \"L Function by City\",\n    subtitle = \"L(r) - r, positive values indicate clustering\",\n    x = \"Distance (r)\",\n    y = \"L(r) - r\"\n  )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\np_k\n```\n\n::: {.cell-output-display}\n![](THE03_files/figure-html/unnamed-chunk-33-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\np_l\n```\n\n::: {.cell-output-display}\n![](THE03_files/figure-html/unnamed-chunk-34-1.png){width=672}\n:::\n:::\n\n\n## 6.0 Kernel Density Estimation (City Level)\n\n### 6.1 KDE Analysis\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# KDE Analysis by City\nkde_city_level <- list()\n\nfor(city in unique(jakarta_schools_utm$city_name)) {\n  city_schools <- jakarta_schools_utm[jakarta_schools_utm$city_name == city,]\n  city_boundary <- adm2_utm[adm2_utm$shapeName == city,]\n  city_window <- as.owin(st_union(city_boundary))\n  \n  win_size <- sqrt(area.owin(city_window))\n  \n  kde_city_level[[city]] <- list()\n  \n  coords <- st_coordinates(city_schools)\n  jittered_coords <- coords + matrix(\n    runif(nrow(coords) * 2, -0.1, 0.1),\n    ncol = 2\n  )\n  \n  inside <- inside.owin(x = jittered_coords[,1],\n                       y = jittered_coords[,2],\n                       w = city_window)\n  valid_coords <- jittered_coords[inside,]\n  \n  if(nrow(valid_coords) >= 4) {\n    points_ppp <- ppp(\n      x = valid_coords[,1],\n      y = valid_coords[,2],\n      window = city_window\n    )\n    \n    h <- bw.scott(points_ppp)\n    kde <- density.ppp(points_ppp, \n                      sigma = h,\n                      edge = TRUE,\n                      at = \"pixels\",\n                      dimyx = c(128, 128))\n    \n    kde_city_level[[city]][[\"All\"]] <- list(\n      kde = kde,\n      n_points = nrow(valid_coords),\n      bandwidth = h\n    )\n  }\n  \n  for(level in unique(city_schools$school_level)) {\n    level_schools <- city_schools[city_schools$school_level == level,]\n    coords <- st_coordinates(level_schools)\n    \n    jittered_coords <- coords + matrix(\n      runif(nrow(coords) * 2, -0.1, 0.1),\n      ncol = 2\n    )\n    \n    inside <- inside.owin(x = jittered_coords[,1],\n                         y = jittered_coords[,2],\n                         w = city_window)\n    valid_coords <- jittered_coords[inside,]\n    \n    if(nrow(valid_coords) >= 4) {\n      points_ppp <- ppp(\n        x = valid_coords[,1],\n        y = valid_coords[,2],\n        window = city_window\n      )\n      \n      h <- bw.scott(points_ppp)\n      kde <- density.ppp(points_ppp, \n                        sigma = h,\n                        edge = TRUE,\n                        at = \"pixels\",\n                        dimyx = c(128, 128))\n      \n      kde_city_level[[city]][[level]] <- list(\n        kde = kde,\n        n_points = nrow(valid_coords),\n        bandwidth = h\n      )\n    }\n  }\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncity_plots <- list()\n\nfor(city in names(kde_city_level)) {\n  plot_list <- list()\n  city_boundary <- adm2_utm[adm2_utm$shapeName == city,]\n  \n  kde_df <- as.data.frame(kde_city_level[[city]][[\"All\"]]$kde)\n  plot_list[[\"All\"]] <- ggplot() +\n    geom_tile(data = kde_df, aes(x = x, y = y, fill = value)) +\n    geom_sf(data = city_boundary, fill = NA, color = \"white\", size = 0.4) +\n    scale_fill_viridis_c(option = \"plasma\", name = \"Density\") +\n    theme_minimal() +\n    theme(\n      plot.title = element_text(size = 10),\n      axis.text = element_text(size = 8),\n      legend.position = \"right\"\n    ) +\n    labs(title = \"All Schools\")\n  \n  legend <- get_legend(plot_list[[\"All\"]])\n  \n  for(level in setdiff(names(kde_city_level[[city]]), \"All\")) {\n    kde_df <- as.data.frame(kde_city_level[[city]][[level]]$kde)\n    plot_list[[level]] <- ggplot() +\n      geom_tile(data = kde_df, aes(x = x, y = y, fill = value)) +\n      geom_sf(data = city_boundary, fill = NA, color = \"white\", size = 0.4) +\n      scale_fill_viridis_c(option = \"plasma\") +\n      theme_minimal() +\n      theme(\n        plot.title = element_text(size = 10),\n        axis.text = element_text(size = 8),\n        legend.position = \"none\"\n      ) +\n      labs(title = level)\n  }\n\n  combined_plots <- wrap_plots(\n    plot_list,\n    ncol = 3,\n    guides = \"collect\"\n  ) +\n    plot_annotation(\n      title = paste(\"School Density Analysis -\", city),\n      theme = theme(\n        plot.title = element_text(size = 14, face = \"bold\", hjust = 0.5)\n      )\n    )\n  \n  city_plots[[city]] <- combined_plots\n}\n\nfor(city in names(city_plots)) {\n  ggsave(\n    filename = paste0(\"kde_\", gsub(\" \", \"_\", city), \".png\"),\n    plot = city_plots[[city]],\n    width = 15,\n    height = 12,\n    dpi = 300\n  )\n}\n```\n:::\n\n\n![](kde_Kota_Jakarta_Utara.png)\n\n![](kde_Kota_Jakarta_Selatan.png)\n\n![](kde_Kota_Jakarta_Timur.png)\n\n![](kde_Kota_Jakarta_Barat.png)\n\n![](kde_Kota_Jakarta_Pusat.png)\n\n### 6.2 Relative Density Metrics\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate relative densities for each city\ndensity_metrics <- data.frame(\n  city = character(),\n  level = character(),\n  max_density = numeric(),\n  mean_density = numeric(),\n  relative_density = numeric(),\n  stringsAsFactors = FALSE\n)\n\nfor(city in names(kde_city_level)) {\n  city_max <- max(kde_city_level[[city]][[\"All\"]]$kde$v, na.rm = TRUE)\n  \n  for(level in names(kde_city_level[[city]])) {\n    if(level != \"All\") {\n      kde_data <- kde_city_level[[city]][[level]]\n      \n      density_metrics <- rbind(density_metrics, data.frame(\n        city = city,\n        level = level,\n        max_density = max(kde_data$kde$v, na.rm = TRUE),\n        mean_density = mean(kde_data$kde$v, na.rm = TRUE),\n        relative_density = max(kde_data$kde$v, na.rm = TRUE) / city_max,\n        stringsAsFactors = FALSE\n      ))\n    }\n  }\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(density_metrics, \n                       aes(x = level, y = relative_density, fill = city)) +\n  geom_bar(stat = \"identity\", position = \"dodge\") +\n  scale_fill_viridis_d(option = \"plasma\") +\n  theme_minimal() +\n  theme(\n    axis.text.x = element_text(angle = 45, hjust = 1),\n    plot.title = element_text(size = 16, face = \"bold\"),\n    axis.title = element_text(size = 12),\n    legend.title = element_text(size = 12),\n    legend.text = element_text(size = 10),\n    plot.margin = margin(20, 20, 20, 20)\n  ) +\n  labs(\n    title = \"Relative Density of School Types by City\",\n    subtitle = \"Maximum density relative to overall school density\",\n    x = \"School Level\",\n    y = \"Relative Density\",\n    fill = \"City\"\n  )\n```\n\n::: {.cell-output-display}\n![](THE03_files/figure-html/unnamed-chunk-38-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "THE03_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}